{% extends 'base.html' %}

{% block title %}ç›‘æ§ä»ªè¡¨æ¿ - åšå®¢ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">ğŸ“Š ç›‘æ§ä»ªè¡¨æ¿</h1>
    </div>
</div>

<!-- å½“å‰çŠ¶æ€æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <h5 class="text-primary">{{ current_hit_rate.hit_rate }}%</h5>
                <p class="card-text">å½“å‰ç¼“å­˜å‘½ä¸­ç‡</p>
                <small class="text-muted">{{ current_hit_rate.hour }}:00 - {{ current_hit_rate.hour|add:1 }}:00</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <h5 class="text-success">{{ current_hit_rate.total_requests }}</h5>
                <p class="card-text">æ€»è¯·æ±‚æ•°</p>
                <small class="text-muted">å½“å‰å°æ—¶</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <h5 class="text-info">{{ current_hit_rate.cache_hits }}</h5>
                <p class="card-text">ç¼“å­˜å‘½ä¸­æ•°</p>
                <small class="text-muted">å½“å‰å°æ—¶</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <h5 class="text-warning">{{ daily_cache_stats.daily_hit_rate }}%</h5>
                <p class="card-text">ä»Šæ—¥å¹³å‡å‘½ä¸­ç‡</p>
                <small class="text-muted">24å°æ—¶å¹³å‡</small>
            </div>
        </div>
    </div>
</div>

<!-- å›¾è¡¨å’Œè¯¦ç»†ç»Ÿè®¡ -->
<div class="row">
    <!-- ç¼“å­˜å‘½ä¸­ç‡è¶‹åŠ¿å›¾ -->
    <div class="col-lg-8">
        <div class="card dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-graph-up"></i> ä»Šæ—¥ç¼“å­˜å‘½ä¸­ç‡è¶‹åŠ¿</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshChart()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportData()">
                        <i class="bi bi-download"></i> å¯¼å‡º
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="hitRateChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- çƒ­é—¨æ–‡ç« æ’è¡Œ -->
    <div class="col-lg-4">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5><i class="bi bi-fire"></i> çƒ­é—¨æ–‡ç«  TOP 5</h5>
            </div>
            <div class="card-body">
                {% if popular_articles %}
                    {% for article in popular_articles %}
                    <div class="d-flex justify-content-between align-items-center py-2 {% if not forloop.last %}border-bottom{% endif %}">
                        <div>
                            <h6 class="mb-1">
                                <a href="{% url 'blog:article_detail' article.id %}" class="text-decoration-none">
                                    {{ article.title|truncatechars:25 }}
                                </a>
                            </h6>
                            <small class="text-muted">{{ article.author }}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-primary">{{ article.reading_stats.total_views }}</div>
                            <small class="text-muted">é˜…è¯»é‡</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">æš‚æ— æ•°æ®</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-table"></i> ä»Šæ—¥è¯¦ç»†ç»Ÿè®¡</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="syncCacheStats()">
                    <i class="bi bi-cloud-upload"></i> åŒæ­¥åˆ°æ•°æ®åº“
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>æ—¶é—´æ®µ</th>
                                <th>æ€»è¯·æ±‚</th>
                                <th>ç¼“å­˜å‘½ä¸­</th>
                                <th>å‘½ä¸­ç‡</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="hourly-stats-table">
                            {% for hour_stat in daily_cache_stats.hourly_stats %}
                            <tr>
                                <td>{{ hour_stat.hour|stringformat:"02d" }}:00 - {{ hour_stat.hour|add:1|stringformat:"02d" }}:00</td>
                                <td>{{ hour_stat.total_requests }}</td>
                                <td>{{ hour_stat.cache_hits }}</td>
                                <td>
                                    <span class="badge {% if hour_stat.hit_rate >= 80 %}bg-success{% elif hour_stat.hit_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ hour_stat.hit_rate }}%
                                    </span>
                                </td>
                                <td>
                                    {% if hour_stat.total_requests > 0 %}
                                        <i class="bi bi-check-circle text-success"></i> æ­£å¸¸
                                    {% else %}
                                        <i class="bi bi-dash-circle text-muted"></i> æ— æ•°æ®
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- APIæ¥å£è¯´æ˜ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-code-square"></i> ç›‘æ§ API æ¥å£</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>å®æ—¶ç›‘æ§</h6>
                        <ul class="list-unstyled">
                            <li><code>GET /api/cache-monitor/</code> - å½“å‰å‘½ä¸­ç‡</li>
                            <li><code>GET /api/cache-monitor/?type=daily</code> - ä»Šæ—¥ç»Ÿè®¡</li>
                            <li><code>POST /api/sync-cache-stats/</code> - åŒæ­¥ç»Ÿè®¡</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>æ–‡ç« ç»Ÿè®¡</h6>
                        <ul class="list-unstyled">
                            <li><code>GET /api/article/{id}/stats/</code> - æ–‡ç« ç»Ÿè®¡</li>
                            <li><code>GET /api/article/{id}/user-stats/</code> - ç”¨æˆ·ç»Ÿè®¡</li>
                            <li><code>GET /dashboard/?format=json</code> - ä»ªè¡¨æ¿æ•°æ®</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å›¾è¡¨å®ä¾‹
    let hitRateChart;
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
        initializeChart();
    });
    
    // åˆå§‹åŒ–å›¾è¡¨
    function initializeChart() {
        const ctx = document.getElementById('hitRateChart').getContext('2d');
        const hourlyStats = {{ daily_cache_stats.hourly_stats|safe }};
        
        const labels = hourlyStats.map(stat => stat.hour + ':00');
        const hitRateData = hourlyStats.map(stat => stat.hit_rate);
        const requestData = hourlyStats.map(stat => stat.total_requests);
        
        hitRateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'å‘½ä¸­ç‡ (%)',
                        data: hitRateData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'è¯·æ±‚æ•°',
                        data: requestData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'æ—¶é—´'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'å‘½ä¸­ç‡ (%)'
                        },
                        min: 0,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'è¯·æ±‚æ•°'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
    
    // åˆ·æ–°å›¾è¡¨æ•°æ®
    function refreshChart() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> åˆ·æ–°ä¸­...';
        
        fetch('/api/cache-monitor/?type=daily')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateChartData(data.data.hourly_stats);
                    updateStatsTable(data.data.hourly_stats);
                    showToast('æ•°æ®å·²æ›´æ–°', 'success');
                } else {
                    showToast('æ›´æ–°å¤±è´¥: ' + data.error_message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'danger');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
    }
    
    // æ›´æ–°å›¾è¡¨æ•°æ®
    function updateChartData(hourlyStats) {
        if (hitRateChart) {
            const labels = hourlyStats.map(stat => stat.hour + ':00');
            const hitRateData = hourlyStats.map(stat => stat.hit_rate);
            const requestData = hourlyStats.map(stat => stat.total_requests);
            
            hitRateChart.data.labels = labels;
            hitRateChart.data.datasets[0].data = hitRateData;
            hitRateChart.data.datasets[1].data = requestData;
            hitRateChart.update();
        }
    }
    
    // æ›´æ–°ç»Ÿè®¡è¡¨æ ¼
    function updateStatsTable(hourlyStats) {
        const tbody = document.getElementById('hourly-stats-table');
        tbody.innerHTML = '';
        
        hourlyStats.forEach(stat => {
            const badgeClass = stat.hit_rate >= 80 ? 'bg-success' : 
                             stat.hit_rate >= 60 ? 'bg-warning' : 'bg-danger';
            
            const statusIcon = stat.total_requests > 0 ? 
                '<i class="bi bi-check-circle text-success"></i> æ­£å¸¸' :
                '<i class="bi bi-dash-circle text-muted"></i> æ— æ•°æ®';
            
            const row = `
                <tr>
                    <td>${stat.hour.toString().padStart(2, '0')}:00 - ${(stat.hour + 1).toString().padStart(2, '0')}:00</td>
                    <td>${stat.total_requests}</td>
                    <td>${stat.cache_hits}</td>
                    <td><span class="badge ${badgeClass}">${stat.hit_rate}%</span></td>
                    <td>${statusIcon}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }
    
    // åŒæ­¥ç¼“å­˜ç»Ÿè®¡åˆ°æ•°æ®åº“
    function syncCacheStats() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> åŒæ­¥ä¸­...';
        
        fetch('/api/sync-cache-stats/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('ç¼“å­˜ç»Ÿè®¡å·²åŒæ­¥åˆ°æ•°æ®åº“', 'success');
            } else {
                showToast('åŒæ­¥å¤±è´¥: ' + data.error_message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
    
    // å¯¼å‡ºæ•°æ®
    function exportData() {
        const data = {{ daily_cache_stats|safe }};
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `cache_stats_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showToast('æ•°æ®å·²å¯¼å‡º', 'success');
    }
    
    // å®šæœŸåˆ·æ–°æ•°æ®ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    setInterval(refreshChart, 5 * 60 * 1000);
</script>
{% endblock %} 